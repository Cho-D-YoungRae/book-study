# Chapter 10. 일반적인 OAuth 토큰 보안 취약점

- 대부분의 공격자의 한 가지 목적은 액세스 토큰(또는 액세스 토큰을 얻기 위한 인가 코드)을 탈취하는 것

## 10.1 Bearer 토큰

- 기술적인 관점에서 보면, Bearer 토큰은 웹 브라우저 쿠키와 매우 유사하다고 생각할 수 있음
  - 공통점
    - 평문으로 된 문자열 사용
    - 시크릿이나 시그니처를 포함하지 않음
    - 보안 모델에 있어서 TLS 는 기본
  - 차이점
    - 웹 브라우저에서는 쿠키를 오래 전부터 사용해왔지만 OAuth 클라이언트에서는 그렇지 않음
    - 웹 브라우저에서는 동일 근원 정책을 강제하기 때문에 어느 한 도메인을 위한 쿠키가 다른 도메인으로 전달되지 않지만, OAuth 클라이언트의 경우에는 그렇지 않음

## 10.2 Bearer 토큰 사용에 있어서 위험과 고려 사항

- `토큰 위조`: 공격자는 자신만의 가짜 토큰을 만들거나 기존의 유효한 토큰을 변조해 리소스 서버가 클라이언트에게 접근 권한을 인가하게 만들 수 있다. 예를 들면, 기존에는 접근할 수 없었던 정보에 접근하기 위해 공격자는 토큰을 인위적으로 만들 수 있다. 또는 토큰을 변조하거나 토큰 자체의 유효성을 확장할 수 있다.
- `토큰 재사용`: 공격자는 이미 과거에 사용돼 유효 기간이 만료된 토큰을 이용하려고 시도한다. 그런 경우, 리소스 서버는 어떤 유효한 데이터도 반환을 해주면 안 되고, 대신 에러를 반환해야 한다. 구체적인 시나리오를 들어보면, 공격자는 처음에는 합법적으로 액세스 토큰을 획득한 후, 해당 토큰이 만료된 이후에 그것을 재사용하려고 시도하는 것이다.
- `토큰 리다이렉트`: 공격자는 특정 리소스 서버를 위해 만들어진 토큰을 이용해 다른 리소스 서버에 접근하려고 시도한다. 그 경우, 공격 대상 리소스 서버는 공격자가 사용한 토큰이 유효한 것이라고 잘못 판단하는 경우다. 즉, 공격자는 특정 리소스 서버를 위한 액세스 토큰을 합법적으로 취득한 후, 그 토큰을 이용해 다른 리소스 서버에 접근하려고 시도하는 것이다.
- `토큰 유출`: 토큰에는 시스템에 대한 민감한 정보가 포함될 수 있고, 공격자는 다른 방법으로는 획득할 수 없는 정보를 토큰을 통해 획득할 수 있다.

## 10.3 토큰 보호 방법

- OAuth 스펙에 따르면, 액세스 토큰은 SSL/TLS 와 같은 종단간의 기밀성을 보장하는 방법으로 전송돼야 함

### 10.3.1 클라이언트에서 탈취

- 클라이언트에 작업에 필요한 최소한의 권한 범위만 토큰에 부여
- 저장돼 관리되는 토큰에 대한 공격을 최소화하기 위해 토큰을 메모리에 일시적으로 유지하는 것도 유용한 방법
  - 그렇게 하면 공격자가 클라이언트의 데이터베이스에 접근할 수 있다고 하더라도 액세스 토큰에 관한 어떤 정보도 얻을 수 없을 것

### 10.3.2 인가 서버에서 탈취

- 공격자가 인가 서버의 데이터베이스에 접근할 수 있거나 데이터베이스에 대한 SQL 인젝션 공격을 수행할 수 있다면, 여러 리소스 소유자의 보안이 침해될 수 있음
- 액세스 토큰 자체의 텍스트 대신 액세스 토큰의 해시 값(예를 들면, SHA-256)을 저장할 수도 있음
- 액세스 토큰 유출과 관련된 위험을 최소화하기 위해 액세스 토큰의 유효 기간을 짧게 유지
- 전반적인 보안 감사와 로깅

### 10.3.3 리소스 서버에서 탈취

- 리소스 서버는 종종 인가 서버와 유사한 방법으로 액세스 토큰을 처리하기 때문에 동일한 수준으로 보안을 처리해야 함
- 액세스 토큰은 시스템 로그상에서 특히 분석을 위해 인입되는 모든 HTTP 트래픽 캡처에서 우연히 유출될 수 있으므로 로그에 포함되지 않도록 토큰 값을 제거해야 함
- 리소스 엔드 포인트는 토큰의 권한 범위를 제한하고 데이터 수집 최소화 원칙과 특정 작업을 수행하기 위해 필요한 최소한의 권한 범위만 요청하도록 설계돼야 함
- 리소스 서버는 토큰을 적절히 검증해야 하고, 어떤 강력한 권한을 가진 특별한 목적의 액세스 토큰을 사용하지 않아야 함
- 액세스 토큰을 메모리에 일시적으로 저장하면 리소스 서버의 데이터 저장소에 대한 공격인 경우에는 도움이 됨
