# Chapter 08. 외부 API 패턴

## 8.1 외부 API 설계 이슈

- MSA 에서 클라이언트가 서비스를 직접 호출하도록 API 를 설계했을 때 단점
  - 서비스 API 가 잘게 나뉘어져 있어서 클라이언트가 필요한 데이터를 가져오려면 **여러번 요청**을 해야하고, 그만큼 효율이 떨어지고 UX 는 나빠짐
  - 클라이언트가 서비스 및 API 를 알아야 하는 구조라서 **캡슐화가 되지 않고**, 나중에 아키텍처와 API 를 바꾸기도 어려움
  - 클라이언트(특히 방화벽 외부에 있는 클라이언트)가 사용하기에 불편하거나 **실용적이지 못한 IPC** 를 서비스에서 사용 중인 경우가 있음

## 8.2 API 게이트웨이 패턴

> API 게이트웨이 패턴: 마이크로서비스 애플리케이션에 외부 API 클라이언트의 진입점에 해당하는 서비스를 구현한다

### 8.2.1 API 게이트웨이 패턴 개요

- API 게이트웨이는 방화벽 외부의 클라이언트가 애플리케이션에 API 요청을 하는 단일 창구 역할을 하는 서비스
- 객체 지향의 퍼사드(Facade) 패턴과 유사
- 내부 애플리케이션 아키텍처를 캡슐화하고 자신의 클라이언트에는 API 를 제공
- API 게이트웨이 주요 기능
  - 요청 라우팅
  - API 조합
  - 프르토콜 변환(protocol translation)
  - 클라이언트마다 적합한 API 를 제공
- 엣지 기능
  - 인증(authentication): 요청한 클라이언트의 신원을 확인
  - 인가(authorization): 특정 작업을 수행하도록 허가받은 클라이언트인지 확인
  - 사용량 제한(rate limiting): 특정(또는 전체) 클라이언트의 초당 요청 개수를 제한
  - 캐싱(caching): 서비스 요청 횟수를 줄이고자 응답을 캐시
  - 지표 수집(metrics collection): 과금 분석용 API 사용 지표 수집
  - 요청 로깅: 요청을 기록
- 엣지 기능이 구현된 곳
  - 백엔드 서비스
  - API 게이트웨이 상류(upstream)
  - 전용 엣지 서비스(dedicated edge service)

#### API 게이트웨이 아키텍처

- API 계층과 공통 계층으로 구성
- API 계층에는 독립적인 하나 이상의 API 모듈이 있고, 각 API 모듈에는 특정 클라이언트용 API 가 구현되어 있음
- 공통 계층에는 엣지 기능 등의 공통 기능이 구현되어 있음
- API 모듈은 두 가지 방법으로 API 작업을 구현
  - 서비스 API 하나에 직접 매핑되는 API 작업은 해당하는 각각의 서비스 API 로 요청을 보냄
    - 라우팅 규칙이 기술된 구성 파일을 읽어 들여 작동되는 범용 라우팅 모듈을 응용할 수 있음
  - API 를 조합하는 복잡한 API 작업은 사용자 정의 코드로 구현
    - API 작업을 구현한 코드는 각각의 여러 서비스를 호출하여 결과를 조합하는 방법으로 요청을 처리

#### 프런트엔드 패턴을 위한 백엔드(BFF)

> BFF 패턴: 각 클라이언트 종류마다 API 게이트웨이를 따로 구현

- API 게이트웨이마다 다른 기술을 사용하여 개발할 수 있지만, 공통 기능 코드가 중복될 우려가 있으므로 모든 API 게이트웨이에 동일한 기술 스택을 적용하는 것이 좋음
- 공통 기능은 API 게이트웨이 팀이 개발한 공유 라이브러리
- API 게이트웨이에 대한 책임을 명확히 정의할 수 있음
- API 모듈이 서로 격리되어 있어 신뢰성 향상
- API 모듈이 자체 프로세스로 작동되므로 관측성 좋아짐
- 각 API 를 독립적으로 확장
- API 게이트웨이를 더 작고 단순한 애플리케이션으로 만들 수 있어서 시동 시간 단축

### 8.2.2 API 게이트웨이의 장단점

#### API 게이트웨이의 장점

- 애플리케이션의 내부 구조를 캡슐화
- 클라이언트마다 최적의 API 를 제공
  - 클라이언트-애플리케이션 간 왕복 횟수 감소
  - 클라이언트 코드 단순해짐

#### API 게이트웨이 단점

- 개발, 배포, 관리를 해야 하는 고가용 컴포넌트가 하나 더 늘어남
- 개발 병목 지점이 될 우려
  - 개발자가 자신의 서비스 API 를 표출하려면 반드시 API 게이트웨이를 업데이트해야 함

### 8.2.4 API 게이트웨이 설계 이슈

- 성능과 확장성
- 리액티브 프로그래밍 추상체를 이용하여 관리 가능한 코드 작성
- 부분 실패 처리
- 애플리케이션 아키텍처에서 선량한 시민 되기

## 8.3 API 게이트웨이 구현

- **기성(off-the-shelf) API 게이트웨이 제품/서비스를 활용**: 개발 노력은 (거의) 안 들지만 유연성은 제일 떨어집니다. 가령 기성 API 게이트웨이 제품은 대체로 API 조합을 지원하지 않습니다.
- **API 게이트웨이 프레임워크 또는 웹 프레임워크를 기반으로 API 게이트웨이를 직접 개발**: 가장 유연한 접근 방식이지만, 적잖은 개발 노력이 투입되어야 합니다.

### 8.3.2 API 게이트웨이 자체 개발

- 코딩 복잡도를 최소화할 수 있는 라우팅 규칙 정의 메커니즘을 구현
- HTTP 헤더 처리 등 HTTP 프록시 로직을 정확히 구현

### 8.3.3 API 게이트웨이 구현: GraphQL

- 그래프 기반의 API 기술 장점
  - 클라이언트가 반환 데이터를 제어
  - 개발 수고를 덜 수 있음
