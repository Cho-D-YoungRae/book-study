# D. 컨테이너 깊게 들여다보기

## D.1 쿠버네티스가 컨테이너를 다루는 과정

> 파드 생성 과정을 컨테이너 중심으로 살펴보기  
> '3.1.5 파드의 생명주기로 쿠버네티스 구성 요소 살펴보기' 에서는 쿠버네티스의 구성 요소를 중심으로 파드가 생성되는 과정을 살펴봄

1. 사용자는 kube-apiserver 의 URL 로 요청을 전달하거나 kubectl 을 통해 명령어를 입력해 kube-apiserver 에 파드를 생성하는 명령을 내림
2. 파드를 생성하는 명령은 네트워크를 통해 kubelet으로 전달
   - kube-apiserver 는 노드에 있는 kubelet 과 안전하게 통신하기 위해 인증서와 키로 통신 내용을 암호화해 전달
   - kubelet 으로 생성 요청이 전달되면 kubelet 은 요청이 적절한 사용자로부터 전달된 것인지를 검증
3. kubelet 에서 요청을 검증하고 나면 컨테이너디에 컨테이너를 생성하는 명령을 내림
    - 명령 형식은 컨테이너 런타임 인터페이스(CRI, Container Runtime Interface)
    - CRI 는 컨테이너와 관련된 명령을 내리는 런타임 서비스(RuntimeService) 와 이미지와 관련된 명령을 내리는 이미지 서비스(ImageService)로 이루어짐
4. 컨테이너디는 containerd-shim 이라는 자식(Child) 프로세스를 생성해 컨테이너를 관리
    - dockerd 는 사용자가 입력한 도커 명령을 컨테이너디에 전달하기 위해 도커 엔진 내부에 생성된 프로세스
5. containerd 가 생성한 containerd-shim 프로세스는 컨테이너를 조작

## D.2 컨테이너 PID 1 의 의미

- 리눅스 운영 체제의 PID 1은 커널이 할당하는 첫 번째 PID 라는 의미의 특수한 PID
  - 일반적으로 init 또는 systemd 에 PID 1이 할당되며 **시스템 구동에 필요한 프로세스들을 띄우는 매우 중요한 역할**
  - PID 1번 이외에도 PID 0번 swapper, PID 2번 kthreadd 등이 미리 예약된 PID 를 가짐
- 컨테이너는 이미 구동된 시스템, 즉 커널 위에서 동작
  - 컨테이너는 운영체제 시스템을 구동시킬 필요가 없이 바로 동작하기 때문에 시스템에 예약된 PID 1번이 할당되지 않은 상태라서 최초 실행자 nginx 에게 할당할 수 있음
  - 그래서 특수한 PID 1번은 컨테이너 세계에서 컨테이너가 실행하는 처음 애플리케이션에게 할당해 사용
- 호스트에서 보이는 프로세스와 컨테이너 프로세스가 연결돼 있음
  - 도커에서 생성한 프로세스도 호스트에서 명령어를 통해 확인 가능 (PID 는 컨테이너 내부와 호스트에서 확인한 것이 다름)
- 리눅스는 자원을 그룹별로 나누어서 할당하고 제한을 설정하기 위해 씨그룹(cgroup)이라는 기술을 사용
  - 씨그룹 설정이 동일하다면 두 프로세스는 동일한 환경에서 동작하는 프로세스로 생각할 수 있음
- 동일한 프로세스가 호스트와 컨테이너 내부에서 서로 다른 PID 를 가지면서 컨테이너 내부에서는 독립된 것처럼 PID 1번 프로세스로 동작할 수 있는 이유는 컨테이너가 리눅스의 네임스페이스(namespace) 기술을 활용하기 때문
  - 네임스페이스는 호스트명, 네트워크, 파일 시스템 마운트, 프로세스 간 통신, 사용자 ID, PID 등의 자원을 격리할 수 있는 기술
  - 네임 스페이스로 격리된 내부에서는 외부가 보이지 않기 떄문에 컨테이너 내부는 독립된 공간처럼 느껴짐
  - 네임스페이스로 격리된 프로세스에 메모리, CPU, 네트워크, 장치 출력 등의 사용량을 할당하고 제한하는 데 앞에서 설명한 씨그룹 기술 사용
  - 이러한 격리 기술을 쉽게 사용할 수 있게 하는 것이 도커
