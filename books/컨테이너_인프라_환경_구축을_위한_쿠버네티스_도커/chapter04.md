# Chapter 04. 쿠버네티스를 이루는 컨테이너 도우미, 도커

## 4.1 도커를 알아야 하는 이유

쿠버네티스를 이루는 기본 오브젝트가 파드, 파드는 컨테이너로 이루어짐, 컨테이너를 만들고 관리하는 도구가 도커

### 4.1.1 파드, 컨테이너, 도커, 쿠버네티스의 관계

- 파드는 1개 이상의 컨테이너로 구성, 파드들은 워커 노드라는 단위로 관리, 워커 노드와 마스터 노드가 모여 쿠버네티스 클러스터
- 컨테이너를 돌보는 것이 파드, 파드를 돌보는 것이 쿠버네티스 워커 노드, 워커노드를 돌보는 것이 쿠버네티스 마스터
- `파드`
  - 쿠버네티스로부터 IP를 받아 컨테이너가 외부와 통신할 수 있는 경로 제공
  - 컨테이너들이 정상적으로 작동하는지 확인하고 네트워크나 저장 공간을 서로 공유하게 함
  - 컨테이너들은 마치 하나의 호스트에 존재하는 것처럼 작동
- `컨테이너`: 하나의 운영체제 안에서 커널을 공유하며 개별적인 실행환경을 제공하는 격리된 공간
  - 개별적인 실행 환경: CPU, 네트워크, 메모리와 같은 시스템 자원을 독자적으로 사용하도록 할당된 환경
  - 개별적인 실행 환경에서는 실행되는 프로세스를 구분하는 ID도 컨테이너 안에 격리돼 관리되므로 각 컨테이너 내부에서 실행되는 애플리케이션들은 서로 영향을 미치지 않고 독립적으로 작동할 수 있음
- `도커`
  - 컨테이너를 사용하는 방법을 명령어로 정리한 것
  - 사용자가 따로 신경쓰지 않아도 컨테이너를 생성할 때 개별적인 실행 환경을 분리하고 자원을 할당

## 4.2 도커로 컨테이너 다루기

### 4.2.1 컨테이너 이미지 알아보기

#### 이미지 검색하고 내려받기

- 이미지는 레지스트리(registry)라고 하는 저장소에 모여 있음
  - 도커 허브처럼 공개된 유명 레지스트리, 내부에 구축한 레지스트리 등...
- 하나의 이미지는 여러 개의 레이어로 구성
- `다이제스트(digest)`: 이미지의 고유 식별자로, 이미지에 포함된 내용과 이미지의 생성 환경을 식별
  - 식별자는 해시 함수로 생성되며 이미지가 동일한지 검증하는 데 사용
  - 이름이나 태그는 이미지를 생성할 때 임의로 지정하므로 이름이나 태그가 같다고 해서 같은 이미지라고 할 수 없음
  - 다이제스트는 고유한 값이므로 다이제스트가 같은 이미지는 이름이나 태그가 다르더라도 같은 이미지

#### 이미지 태그

> 이름이 동일한 이미지에 추가하는 식별자

- 이름이 동일해도 도커 이미지의 버전이나 플랫폼(CPU 종류나 기본 베이스를 이루는 운영 체제 등)이 다를 수 있기 때문에 이를 구분하는 데 사용
- 기본은 latest 태그
- 컨테이너를 배포할 때는 latest 태그가 아닌 검증된 버전으로 배포해야 문제가 생기지 않음

#### 이미지의 레이어 구조

- 이미지는 애플리케이션과 각종 파일을 담고 있다는 점에서 ZIP 같은 압출 파일로 볼 수 있음
- 이미지는 같은 내용일 경우 여러 이미지에 동일한 레이어를 공유하므로 용량을 효율적으로 사용 가능
- `docker history` : 컨테이너 이미지 자체를 만드는 명령을 보여줌

### 4.2.2 컨테이너 실행하기

- 컨테이너를 생성하면 컨테이너 고유 ID 반환
- `docker run`: 새로운 컨테이너 실행
  - `-d(--detach)`: 컨테이너를 백그라운드에서 구동
    - 옵션을 생략하면 컨테이너 내부에서 실행되는 애플리케이션의 상태가 화면에 계속 표시됨
    - 이 상태를 빠져 나오려고 Ctrl+C 를 누르면 애플리케이션 뿐만 아니라 컨테이너도 함께 중단
    - 계속 작동해야 하는 서버나 데이터베이스 같은 프로그램은 -d 옵션을 붙여 백드라운뎅서 작동하게 함
  - `--restart always`: 컨테이너의 재시작과 관련된 정책
    - 프로그램에 예상하지 못한 오류가 발생하거나 리눅스 시스템에서 도커 서비스가 중지되는 경우 컨테이너도 작동이 중지됨
    - 이때 중지된 컨테이너를 즉시 재시작하거나 리눅스 시스템에서 도커 서비스가 작동할 때 컨테이너를 자동으로 시작하도록 설정 가능
- `docker ps`: 생성한 컨테이너 상태 확인
  - `COMMAND`: 컨테이너가 생성될 때 내부에서 작동할 프로그램을 실행하는 명령어
  - `-f`: 검색 결과 필터링 옵션
    - id, name, label, exited, status, ancestor, ...
- 컨테이너는 변경 불가능한 인프라(immutable infrastructure)를 지향
  - 초기에 인프라를 구성하면 임의로 디렉터리 연결이나 포트 노출과 같은 설정르 변경 불가능
  - 컨테이너에 적용된 설정을 변경하려면 새로운 컨테이너를 생성해야 함
  - 이러한 특성 덕분에 컨테이너로 배포된 인프라는 배포된 상태를 유지한다는 장점
- 요청이 호스트에 도달한 후 컨테이너로 도달하기 위한 추가 경로 설정 필요
- `-p(--publish) <요청 받을 호스트 포트>:<연결할 컨테이너 포트>` : 외부에서 호스트로 보낸 요청을 컨테이너 내부로 전달
- 컨테이너 내부에서 웹 페이지 파일을 변경할 수 있지만 이런 경우, 컨테이너를 다시 생성하게 되면 매번 웹페이지 파일을 전송해야 함
- 그러므로 영속적으로 웹페이지 파일을 사용하기 위해서는 특정 디렉터리와 컨테이너 내부의 디렉터리를 연결하는 것이 효과적인 사용법
