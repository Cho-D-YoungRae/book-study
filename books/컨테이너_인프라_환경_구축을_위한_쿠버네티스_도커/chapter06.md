# Chapter 06. 안정적인 운영을 완성하는 모니터링, 프로메테우스와 그라파나

## 6.1 컨테이너 인프라 환경 모니터링하기

다수의 노드로 구성된 클러스터 정보를 모두 표한해야 함

### 6.1.1 모니터링 도구 선택하기

- 오픈 소스는 가능한 한 단일 도구에서 단일 기능만을 구현하는 것을 선호
  - 데이터 수집과 통합: 프로메테우스, 시각화: 그라파나
- 서비스형 모니터링 도구는 사용자의 편의를 위해 이러한 기능을 모아서 한꺼번에 제공
- 서비스형 모니터링 도구를 사용하지 않고 프로메테우스와 그라파나 혼합 구조를 사용하는 이유
    1. **비용**: 모니터링 대상마다 라이선스(License)관련 비용이 발생하고, 클라우드 같은 과금제 서비스를 이용하면 네트워크와 저장 공간에 따른 추가 비용 발생하므로 비용에 민감한 조직에는 도입 어려움
    2. **보안**: 서비스형 모니터링 도구들은 대부분 외부에 데이터를 저장해 모니터링 하므로 보안에 민감해서 내부에서 모든 데이터를 처리하려는 경우에는 사용하기 어려움

### 6.1.2 쿠버네티스 환경에 적합한 모니터링 데이터 수집 방법

- `cAdvisor`: 쿠버네티스 클러스터 위에 배포된 여러 **컨테이너가 사용하는 메트릭 정보**를 수집한 후 이를 가공해서 kubelet 에 전달
  - 쿠버네티스 노드는 kubelet 을 통해 파드를 관리
  - 파드의 CPU 나 메모리 같은 메트릭 정보를 수집하기 위해 kubelet 에 내장된 cAdvisor 을 사용
- 메트릭 데이터를 수집하는 목적으로 메트릭 서버 설치
- `리소스 메트릭 파이프라인(Resource Metric Pipeline)`: 메트릭 서버에서 수집한 데이터로 여러 기능을 수행하도록 구성한 것
- `완전한 모니터링 파이프라인(Full Monitoring Pipeline)`: 메트릭 서버는 집계한 데이터를 메모리에만 저장하므로 데이터를 영구적으로 보존하기 어렵고 현재 시점의 데이터만 추력되기 때문에 메트릭 데이터를 저장 공간에 따로 저장

## 6.2 프로메테우스로 모니터링 데이터 수집과 통합하기

- `프로메테우스 서버(prometheus-server)`
  - 노드 익스포터 외 여러 대상에서 공개된 **메트릭을 수집해 오는 수집기**
  - 수집한 시계열 메트릭 데이터를 저장하는 **시계열 데이터베이스**
  - 저장된 데이터를 질의하거나 수집 대상의 상태를 확인할 수 있는 웹 UI
  - `서비스 디스커버리(Service Discovery)`라는 방법으로 수집 대상을 찾음
- `노드 익스포터(node-exporter)`
  - 노드의 **시스템 메트릭 정보**를 HTTP로 공개하는 역할
  - 설치된 노드에서 특정 파일들을 읽고, 이를 프로메테우스 서버가 수집할 수 있는 데이터로 변환한 후에 노드 익스포터에서 HTTP 서버로 공개
  - 공개된 내용을 프로메테우스 서버에서 수집
- `쿠버 스테이트 메트릭(kube-state-metrics)`
  - API 서버로 **쿠버네티스 클러스터의 여러 메트릭 데이터**를 수집한 후, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개하는 역할
- `얼럿매니저(alertmanager)`
  - 프로메테우스에 경보(alert) 규칙을 설정하고, 경보 이벤트가 발생하면 설정된 경보 메시지를 대상에게 전달하는 기능 제공
- `푸시게이트웨이(pushgateway)`
  - 배치와 스케줄 작업 시 수행되는 일회성 작업들의 상태를 저장하고 모아서 프로메테우스가 주기적으로 가져갈 수 있도록 공개
  - 일반적으로 짧은 시간동안 실행되고 종료되는 배치성 프로그램의 메트릭을 저장하거나 외부망에서 접근할 수 없는 내부 시스템의 메트릭을 프록시 형태로 제공하는 용도로 사용
  - 필요에 따라 구성

### 6.2.1 헬름으로 프로메테우스 설치하기

### 6.2.2 프로메테우스의 웹 UI 다루기

### 6.2.3 서비스 디스커버리로 수집 대상 가져오기

- 프로메테우스는 수집 대상을 자동으로 인식하고 필요한 정보를 수집
- 정보를 수집하려면 일반적으로 에이전트를 설정해야 하지만, 쿠버네티스는 서비스 디스커버리 덕분에 사용자가 에이전트에 추가로 입력할 필요없이 자동으로 메트릭 수집 가능
- 서비스 디스커버리 동작 순서
    1. 프로메테우스 서버는 컨피그맵에 기록된 내용을 바탕으로 대상을 읽어옴
    2. 읽어온 대상에 대한 메트릭을 가져오기 위해 API 서버에 정보를 요청
    3. 요청을 통해 알아온 경로로 메트릭 데이터를 수집
- 서비스 디스커버리 방법은 대상에 따라 크게 2가지 경로
    1. 쿠버네티스 API 서버에 직접 연결돼 메트릭을 수집하는 **cAdvisor**
    2. API 서버가 경로를 알려 주어 메트릭을 수집할 수 있는 **에이전트**(익스포터)

#### cAdvisor

- cAdvisor 의 메트릭이 API 서버를 통해 노출되면 프로메테우스 서버가 쉽게 수집하도록 변환하는 과정을 거침
- cAdvisor 로 수집된 메트릭은 container 라는 이름으로 시작
- 새로 디플로이먼트를 추가하면 자동으로 메트릭 수집
  - prometheus-server 컨피그맵에 수집 대상이 지정
- 각 노드에 컨테이너 시스템 정보를 담고 있는 특정 파일들을 읽어 들여 메트릭을 수집

#### 익스포터

- 서비스 디스커버리에서 수집은 자동으로 이뤄지지만, 익스포터는 사전 준비 작업 2가지를 해야 함
    1. API 서버에서 등록돼 경로를 알 수 있게 해야 함
    2. 익스포터가 데이터를 프로메테우스 타입으로 노출해야 함
- 프로메테우스 서버가 배포된 애플리케이션을 API 서버에서 찾아 메트릭을 수집하려면 애너테이션 설정이 가장 중요한데, 이는 매니페스트에 적용
- 메트릭이 공개되어야 메트릭을 수집할 수 있음, 메트릭 공개 방법
    1. 프로그래밍 언어의 프로메테우스 SDK를 사용해 직접 메트릭을 공개
    2. 이미 만들어 둔 익스포터를 사용해 메트릭을 공개하는 방법

### 6.2.4 노드 익스포터로 쿠버네티스 노드 메트릭 수집하기

- 노드 익스포터는 익스포터 중에서도 쿠버네티스 노드의 상태 값을 메트릭으로 추출하는 데 특화
- 노드 익스포터를 실행하기 위해서 쿠버네티스 노드마다 1개씩 배포할 수 있는 데몬셋으로 구현돼 배포
- /proc 과 /sys 에 있는 값을 메트릭으로 노출하도록 구현
  - **/proc**: 리눅스 운영체제에서 구동 중인 프로세스들의 정보를 파일 시스템 형태로 연결한 디렉터리
  - **/sys**: 저장 장치, 네트워크 장치, 입출력 장치 같은 각종 장치를 운영 체제에서 사용할 수 있도록 파일 시스템 형태로 연결한 디렉터리
  - 노드 익스포터는 각 쿠버네티스 노드의 /proc, /sys 에 있는 파일들을 읽어서 프로메테우스가 받아드릴 수 있는 메트릭 형태로 변환 후 변환한 메트릭을 HTTP 서버를 통해 /metrics 주소로 공개
- 노드 익스포터의 메트릭은 node 로 시작

### 6.2.5 `쿠버 스테이트 메트릭`으로 쿠버네티스 클러스터 메트릭 수집하기

- 쿠버네티스 상태를 보여주는 메트릭
- 쿠버네티스 상태에 관한 정보를 가지고 와서 프로메테우스가 받아들일 수 있는 메트릭 형태로 변환하고 HTTP 서버를 통해 /metrics 주소로 공개
- ~~각 노드의 특정 디렉터리를 마운트해서 사용하지 않고~~ 이미 **API 서버에 모인 값**들을 수집한다는 점이 노드 익스포터와 다름
- kube 로 시작

## 6.3 PromQL 로 메트릭 데이터 추출하기

### 6.3.1 메트릭 데이터의 구조

#### 메트릭 값의 종류

- `카운터(Counter)`
  - **누적된 값**을 표현하는 데 사용하는 메트릭 타입
  - 누적된 값으로 구간별 **변화율**을 파악해 해당 값이 어느 정도 추세로 증가하는지 알 수 있음
  - 급증하는 구간을 파악하는 데 적합 (이벤트나 오류 등)
- `게이지(Gauge)`
  - **특정 시점의 값**을 표현하는 데 사용하는 메트릭 타입
  - 시점 별로 증가나 감소를 모듀 표현
  - 누적된 값이 필요하지 않고 조회하는 순간의 값이 중요한 것 (CPU 온도, 메모리 사용량, ...)
- `히스토그램(Histogram)`
  - 사전에 미리 정의한 구간 안에 있는 메트릭 값의 빈도를 측정
  - 익스포터를 구현하는 단계에서 정의한 구간을 **버킷(bucket)** 이라고 함
  - 예) 클라이언트가 서버로 HTTP 요청을 한 경우에 응답 시간과 맞는 버킷에 값을 추가하고 이벤트 횟수를 저장해 표시
- `서머리(Summary)`
  - 구간 내에 있는 메트릭 값의 빈도를 측정
  - 히스토그램과 달리 구간이 지정되는 것이 아니라 프로메테우스 자체로 0~1 사이로 구간을 미리 정해 놓음

#### 메트릭 레이블

- 모든 메트릭 데이터는 하나 이상의 레이블을 가짐
- 메트릭 데이터의 다양한 내용을 표현하는 유일한 방법
- 단순히 1~2개의 레이블이 아니라 제공하고 싶은 다수의 내용을 key-value 형태로 넣음

#### 메트릭 레이블 매처

- `=`: 조건에 넣은 값과 레이블 값이 같은 메트릭
- `!=`: 조건에 넣은 값과 레이블 값이 다른 메트릭
- `=~`: 조건에 넣은 정규 표현식에 해당하는 메트릭
- `!~`: 조건에 넣은 정규 표현식에 해당하지 않는 메트릭

### 6.3.2 PromQL 연산자

- `비교 연산자`: 레이블 매처와 유사한 형태이나 비교 대상이 숫자이므로 크기를 구분하는 조건들이 있음 (==, !=, \>, \<, \<=, \>=)
- `논리 연산자`: 수집된 메트릭에서 보고 싶은 범위를 지정 (and, or, unless)
- `산술 연산자`: 메트릭의 값을 사용자가 원하는 값으로 변환 (+, -, *, /, %, ^)
- `집계 연산자`: 수집된 메트릭을 종합하고 분석하는 연산자로 메트릭의 값을 좀 더 의미 있는 데이터로 정리 (avg, sum, count)

### 6.3.3 PromQL 데이터 타입

- 시간을 포함한 메트릭 데이터를 확인하려면 쿼리를 입력할 때 \[구간 값]을 입력해야 함
- `레인지 셀렉터(Range Selector)`: 메트릭 데이터를 받아오는 구간
- `레인지 벡터(Range vector)`: 구간이 있는 PromQL 데이터 타입
- `인스턴트 벡터(Instant vector)`: 특정(일반 적으로 현재 시점) 시점에 대한 메트릭 값만을 갖는 PromQL 데이터 타입
- `스칼라 타입(Scalar type)`: 실수 값을 표현, 인스턴트 벡터 값을 변경하는 용도로 사용되고 단독으로는 사용하지 않음
- `스트링 타입(String type)`: 문자열 표현, 프로메테우스 2.0 부터는 사용하지 않음

#### 시계열 메트릭 데이터로 그래프 그리기

- 게이지 타입으로 수집된 메트릭 데이터를 그래프로 그리면 한눈에 상태 변화를 확인할 수 있음
- 카운터 타입은 항상 증가하는 값이기 때문에 그래프로 그리면 계속 증가하는 형태로만 보이고 어떠한 의미도 알아낼 수 없음
- 카운터 타입으로 구성된 레인지 벡터를 이용해 유의미한 결과를 만들어야 함

### 6.3.4 PromQL 함수

|종류|용도|함수|
|---|---|---|
|연산 함수|수학 연산에 사용|abs(절댓값), ceil(올림), floor(내림), round(반올림), predict_linear(예측값) 등|
|변환 함수|데이터 타입 간 변환에 사용|scalar(스칼라로 변환), vector(벡터로 변환), rate(변환율), irate(순간 변환율) 등|
|집계 함수|수집된 레인지 벡터의 데이터 집계를 위해 사용|avg_over_time(평균), sum_over_time(합계), count_over_time(계수) 등|

#### 변환율을 나타내는 rate

- 수집한 값들의 변환율을 구할 때 사용
- 주로 값이 증가하는 카운터 형식의 메트릭에 사용
- 지정된 구간이 얼마나 빠르게 변화했는지 알기 위한 지표로 사용
- 프로메테우스에서 제공하는 그래프의 단점 -> 그라파나 사용
  - 변화율 값을 정확하게 표시 못함
  - 제한이 많은 꺾은선 그래프로 표시돼 추이 변화를 파악하기 어려움
  - 하나의 패널로 구성돼 여러 가지의 PromQL 쿼리를 비교할 수 없음

#### 순간변화율을 나타내는 irate

- rate 는 구간 시작 값과 구간 종료 값의 차이에 대한 변화율
- irate 는 구간 종료 바로 전 값과 구간 종료 값의 차이
- 구간이 매우 길면 irate 의 변화율은 큰 의미가 없기 때문에 rate 를 사용하는 것이 나음

#### 추세를 보여주는 predict_linear

- 레인지 벡터로 수집된 과거 메트릭 데이터를 기반으로 앞으로 생성될 메트릭 값을 예측

### 6.3.5 서머리와 히스토그램

> 서머리와 메트릭은 구간 내에 특정 메트릭 값이 나타나는 빈도를 알려줌

#### 서머리

- 익스포터에서 이미 만들어진 값을 보여줌
- 이미 공개된 메트릭 값을 조회하면 바로 확인 가능
- 결과에서 quantile(분위수)의 값에 매핑되는 메트릭 값을 확인

#### 히스토그램

- 요청을 받으면 이를 계산해서 보여줌
- 쿼리 입력기에서 쿼리를 보내면 그떄서야 내부 계산식을 통해 히스토그램 메트릭을 생성

#### 히스토그램에 연산자 추가하기

- by (le) 사용
- le 는 개발자가 미리 정해 둔 버킷의 기준값

## 6.4 그라파나로 모니터링 데이터 시각화 하기

### 6.4.1 헬름으로 그라파나 설치하기

### 6.4.2 프로메테우스를 데이터 소스로 구성하기

#### 쿠버네티스 내에서 도메인 이름을 제공하는 CoreDNS

- 파드와 서비스가 배포될 때 IP 주소 정보와 도메인 이름을 자동으로 등록해 도메인 이름으로 연결할 수 있게 함
- IP 로 직접 연결하기보다는 도메인 이름으로 구성해 파드와 서비스 IP 가 변경됐을 떄 유연하게 대응

### 6.4.3 노드 메트릭 데이터 시각화하기

### 6.4.4 파드 메트릭 데이터 시각화 하기

## 6.5 좀 더 견고한 모니터링 환경 만들기

### 6.5.1 얼럿매니저로 이상 신호 감지하고 알려주기

- 이상 신호가 담긴 경보 메시지를 받으려면
  - 그라파나의 얼럿 메뉴
  - 프로메테우스의 얼럿매니저
- 그라파나의 얼럿 메뉴는 오직 시각화 그래프에만 존재하기 때문에 제한적으로 사용해야하고, 메시지를 다양한 형태로 보낼 수 없다는 단점
