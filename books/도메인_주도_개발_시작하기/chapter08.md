# Chapter 08. 애그리거트 트랜잭션 관리

## 8.1 애그리거트와 트랜잭션

- 애그리거트의 일관성이 깨지지 않도록 트랜잭션 처리

## 8.2 선점 잠금(Pessimistic Lock)

- 선점 잠금은 먼저 애그리거트를 구한 스레드가 애그리거트 사용이 끝날 떄까지 다른 스레드가 해당 애그리거트를 수정하지 못하게 막는 방식
- JPA 에서 `LockModeType.PESSIMISTIC_WRITE` 사용

### 8.2.1 선점 잠금과 교착 상태

- 선점 잠금 기능을 사용할 때는 잠금 순서에 따른 교착상태(Deadlock)가 발생하지 않도록 주의
- 잠금을 구할 때 최대 대기 시간을 지정해야 함

## 8.3 비선점 잠금

- 선점 잠금으로 모든 트랜잭션 충돌 문제가 해결되는 것은 아님
  - 서로 다른 쓰레드에서 '조회A -> 조회B -> 수정B -> 수정A' 발생했을 때, B에서 수정이 발생하고 A에서 수정이 또 발생하게 됨
- 비선점 잠금은 동시에 접근하는 것은 막는 대신 변경한 데이터를 실제 DBMS 에 반영하는 시점에 변경 가능 여부를 확인하는 방식
- 비선점 잠금을 구현하려면 애그리거트에 버전으로 사용할 숫자 타입을 추가해야 함
- 시스템이 사용자에게 수정폼을 제공할 때 애그리거트 버전을 함께 제공하고, 폼을 서버에 전송할 때 이 버전을 함께 전송하여 사용자가 전송한 버전과 애그리거트 버전이 동일한 경우에만 애그리거트 수정 기능을 수행하도록 함으로써 트랜잭션 충돌 문제를 해소할 수 있음

### 8.3.1 강제 버전 증가

- 애그리거트에 애그리거트 루트 외에 다른 엔티티가 존재하는데 기능 실행 도중 루트가 아닌 다른 엔티티의 값만 변경되는 경우 JPA 는 루트 엔티티의 버전 값을 증가시키지 않음
- 애그리거트 내에 어떤 구성 요소의 상태가 바뀌면 루트 애그리거트의 버전 값이 증가해야 비선점 잠금이 올바르게 동작함
- `LockModeType.OPTIMISTIC_FORCE_INCREMENT` 를 사용하면 해당 엔티티의 상태가 변경되었는지에 상관없이 트랜잭션 종료 시점에 버전 값 증가 처리를 함

## 8.4 오프라인 선점 잠금

- 오프라인 선점 잠금(Offline Pessimistic Lock)은 여러 트랜잭션에 걸쳐 동시 변경을 막음
- 첫 번째 트랜잭션을 시작할 때 오프라인 잠금을 선점하고, 마지막 트랜잭션에 잠금을 해제, 잠금을 해제하기 전까지는 다른 사용자는 잠금을 구할 수 없음
- 잠금 유효 시간을 가져야함
- 일정 주기로 유효 시간을 증가시키는 방식이 필요
