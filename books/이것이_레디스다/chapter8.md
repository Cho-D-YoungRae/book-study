# Chapter 8. 확장과 분산 기법

- 레디스는 단일 스레드로 동작
  - 레디스 인스턴스가 사용할 수 있는 최대 CPU 개수는 하나이므로 전통적인 관계형 데이터베이스와는 달리 서버의 성능을 높이는 것은 성능 향상에 큰 도움이 되지 않음
  - 동일한 사양의 시스템을 추가하는 방법으로 성능 향상 -> 통상적으로 NoSQL에서 사용하는 스케일 아웃
- 레디스는 스케일 아웃을 처리하기 위한 방법 2가지 기법 제공
  - 읽기 분산을 위한 복제(Replication)
  - 쓰기 분산을 위한 샤딩(Sharding)
- 확장 방법에 관련된 용어
  - `복제`: 클라이언트가 어느 노드에 접근하더라도 동일한 데이터를 읽을 수 있도록 데이터를 각 노드에 복제하여 저장하는 것을 말한다.
  - `샤딩`: 데이터를 특정 조건에 따라 나누어 저장하는 것을 말한다. 예를 들어 1부터 10까지 10개의 데이터를 2 대의 노드를 사용하여 샤딩을 수행한다고 가정하자. 이때 첫 번째 노드에 1부터 5까지의 데이터를 저장하고 두 번째 노드에 6부터 10까지의 데이터를 저장하여 데이터를 분할 저장하는 방법을 샤딩이라 말한다.
  - `샤드`: 2 개의 노드를 사용하여 데이터를 분할 저장하였을 때 각 노드를 샤드라고 무른다. 만약 각 샤드가 복제를 사용하여 여러 개의 노드로 구성될 때에도 하나의 샤드로 취급한다.

## 8.1 복제

> 동일한 데이터를 다중의 노드에 중복하여 저장하는 것

- 마스터는 복제를 위한 데이터의 원본 역할
- 슬레이브는 마스터 노드에 데이터 복제 요청을 하고 데이터를 수신하여 동기화
- 읽기 성능의 증대를 위해서 사용
- 대부분의 서비스는 데이터베이스에 대한 읽기와 쓰기 비율이 1:9 또는 2:8
- 기본저긍로 마스터 노드에서 쓰기 연산을 수행하고 슬레이브 노드에서 읽기 연산을 수행하도록 읽기와 쓰기를 완전히 분리
  - 확장 구조의 유연성을 가질 수 있음
  - 어플리케이션 레벨에서 사용할 수 있는 명령의 한계와 복잡도 증가

### 8.1.1 단일 복제

- 마스터 노드 하나와 슬레이브 노드 하나
- 마스터 노드에 변경이 발생하면 실시간으로 슬레이브 노드에 데이터 변경사항 기록
- 슬레이브 노드에 데이터 변경이 발생하면 마스터 노드는 해당 변경사항을 감지하지 못 하므로 데이터의 정합성이 무너짐

### 8.1.2 다중 복제

- 단일 복제만으로 필요한 읽기 성능을 만족하지 못할 때
- 단일 복제 구조의 클러스터에 슬레이브 노드를 추가
- 마스터 노드에서 데이터를 슬레이브 노드로 복제하기 위해서 필요한 리소스는 마스터 노드의 CPU와 네트워크 그 중 네트워크 리소스의 비용이 가장 큼
- 하나의 마스터 노드에 너무 많은 슬레이브 노드가 접속되면 마스터 노드가 가진 대부분의 리소스가 복제를 위한 데이터 동기화에 사용되어 전체적인 성능 저하

### 8.1.3 계층형 복제

- 마스터 노드에 너무 많은 슬레이브가 접속되어 쓰기 성능이 저하되는 문제점을 해결하기 위한 복제 방법
- 마스터 노드와 슬레이브 노드1이 1차로 복제되어 동기화되고, 그 이후 슬레이브 노드2, 3, 4가 1로부터 복제
- 슬레이브 노드1은 1차 복제를 수행하기 위해 리소스 부족을 염려하여 읽기와 쓰기 연산을 수행하지 않도록 구성
  - 리소스가 충분하다면 슬레이브 노드1에서 읽기 연산을 수행하여도 무방
- 레디스의 클러스터 구성에서는 듀얼 마스터 또는 다중 마스터 복제를 지원하지 않음

## 8.2 샤딩

> 다른 용어로 파티셔닝(Partitioning)이라고 함. 데이터를 특정 조건에 따라서 서버에 분산 저장

- 데이터 파티셔닝은 두 가지 관점에서 유용
  1. 더 많은 데이터를 레디스에 저장 가능
    - 복제를 사용했을 때 레디스에 저장 가능한 데이터의 전체 크기는 마스터 노드의 메모리 크기와 동일하거나 더 작음
  2. 쓰기 성능의 증대
- 2.6 버전까지는 서버 측 샤딩을 지원하지 않음
- 레디스 클라이언트에서 적용 가능한 샤딩의 방법
  - `수직 샤딩(Vertical Sharding)`: 관계형 데이터베이스의 테이블에 해당하는 정보를 노드별로 분할하는 방법이다. 예를 들어 사용자 정보는 첫 번째 노드, 친구 정보는 두 번째 노드에 저장하는 방식을 말한다.
  - `범위 지정 샤딩(Range Sharding)`: 키를 특정 범위를 기준으로 분할하여 저장하는 방법이다. 예를 들어 1부터 1,000까지의 키가 있을 때 1부터 500까지의 키는 첫 번째 노드, 501부터 1,000까지의 키는 두 번쨰 노드에 저장하게 된다.
  - `해시 기반 샤딩(Hash Based Sharding)`: 키를 해시 함수에 대입하여 결과값에 특정 연산을 가해 데이터의 위치를 결정하는 방법을 말하는데, 일관된 해싱(Consistent Hashing)이라고도 한다.

### 8.2.1 수직 샤딩

- 데이터의 성격을 기준으로 논리적 분할을 적용한 것
- 관계형 데이터베이스를 예로 들면 사용자 정보는 샤드1, 친구 정보는 샤드2에 저장
- 데이터의 위치를 서비스 레벨에서 지정하기 때문에 몇 가지 이슈가 발생 가능
  1. 수직 샤딩에 의해 분리 저장된 엔터티에 대한 처리 요청이 증가하는 상황
    - 하나의 노드가 친구와 관련된 서비스를 제공하므로 처리 성능 확장을 위해서 서비스의 수정과 같은 복잡한 처리 과정을 거쳐야 함
    - 데이터를 다른 하드웨어에 설치된 노드로 이동해야 하는데, 이떄 필연적으로 서비스 중단이 뒤따름
  2. 데이터의 저장과 조회가 전적으로 애플리케이션 레벨에서 결정
    - 서비스 어플리케이션을 개발하는 시점에 샤드에 저장된 정보를 알고 있어야 하기 때문에 애플리케이션의 복잡도 증가
    - 애플리케이션의 복잡도를 줄이기 위해 테이블 엔터티 기반의 서비스 추상화를 시도하지만 추상화 서비스 개발의 추가적인 부담
- 관계형 데이터베이스의 샤딩에서 종종 사용

### 8.2.2 범위 지정 샤딩

- 입력되는 특정 키에 대하여 범위를 지정하여 저장될 노드를 결정하는 것
- 수직 샤딩과 마찬가지로 어플리케이션 레벨에서 데이터의 저장 위치가 결정되며 발생 가능한 문제점 또한 유사

### 8.2.3 해시 기반 샤딩

- 키의 해시값을 구하여 해시값에 대한 특정 연산을 통해서 키가 저장될 위치를 구함

## 8.3 샤딩과 복제 혼합
