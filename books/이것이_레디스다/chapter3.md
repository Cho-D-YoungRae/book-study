# Chapter 3. NoSQL

## 3.3 CAP 정리

> 일관성(Consistency), 가용성(Availability), 분할 허용성(Partion Tolerance) 모두를 동시에 지원하는 분산 컴퓨터 시스템은 없다.

NoSQL은 기본적으로 분산 환경에서 잘 동작하도록 설계되어 있다. 즉, 동일한 성격의 데이터가 물리적으로 다른 하드웨어에 저장되고 조회된다. 이때 각 NoSQL은 일관성, 가용성, 분할 허용성 가운데 두 가지 속성만을 지원하며 나머지 한 속성은 특정 조건에서만 만족한다.

### 3.3.1 일관성

> 동시성 또는 동일성이라고도 하며 '다중 클라이언트에서 같은 시간에 조회하는 데이터는 항상 동일한 데이터임을 보증하는 것'

- 관계형 데이터베이스가 지원하는 가장 기본적인 기능이지만 NoSQL에서는 빠른 분산 처리를 위해 일관성을 희생하기도 함
- NoSQL 분산 노드 간의 데이터 동기화를 위한 2가지 방법
  1. 데이터의 저장 결과를 클라이언트로 응답하기 전에 모든 노드에 데이터를 저장하는 동기식 방법
      - 모든 노드의 데이터 저장이 완료되는 시간 동안 클라이언트에게 저장결과를 돌려줄 수 없으므로 느린 응답시간
      - 강한 데이터 정합성
  2. 특정 이벤트 또는 프로세스를 사용하여 노드로 데이터를 동기화하는 비동기식 방법
      - 클라이언트에게 빠른 응답을 줄 수 있음
      - 쓰기 노드에 장애가 발생하였을 때 데이터를 잃어버릴 수 있음

### 3.3.2 가용성

> '모든 클라이언트의 읽기와 쓰기 요청에 대하여 항상 응답이 가능해야합을 보증하는 것'

- 내고장성을 가진 NoSQL은 클러스터 내 몇 개의 노드가 망가지더라도 정상적인 서비스 가능
- 몇몇 NoSQL은 이와 같은 가용성을 보장하기 위해 데이터 복제를 사용
  - 동일한 데이터를 가진 저장소를 하나 더 생성하는 마스터-슬레이브 복제 방법
  - 데이터 단위로 중복 저장하는 피어-투-피어 복제 방법
  - 단일 고장점: 시스템을 구성하는 개별 요소 중에서 하나의 요소가 망가졌을 때 시스템 전체를 멈추게 만드는 요소

### 3.3.3 네트워크 분할 허용성 (Partition tolerance)

> 지역적으로 분할된 네트워크 환경에서 동작하는 시스템에서 두 지역 간의 네트워크가 단절되거나 네트워크 데이터 유식이 일어나더라도 각 지역 내의 시스템은 정상적으로 동작해야 함

## 3.4 NoSQL의 분류

모든 NoSQL의 특징과 정확히 부합하지는 않을 수 있으므로 각 모델에 대한 저장 개념을 이해하고, NoSQL 분류에 따른 특징을 비교하는 참고 자료로 활용

### 3.4.1 키-값 모델 NoSQL

#### 공통 특징

- 저장 가능한 데이터의 종류는 NoSQL별로 상이
- 대부분의 키-값 모델 NoSQL은 단순한 저장구조로 인하여 복잡한 조회 연산을 지원하지 않음
- 고속 읽기와 쓰기에 최적화된 경우가 많음
- API가 단순하여 NoSQL을 처음 접하는 사용자가 쉽게 이해하고 사용할 수 있음
- 대부분 저장된 데이터에 대한 검증이나 데이터의 내용에 기반한 조회를 지원하지 않음
- 저장되는 값을 단지 의미 없는 바이너리 데이터로 처리
- 레디스, 리악, 볼드모트, ...

#### 데이터 저장 방법

- 단일 키에 단일 데이터를 저장하는 구조
- 단순한 정보의 빠른 저장과 조회 제공
- 상황에 따라 복잡한 정보를 저장하기 위해 키에 정보를 포함하도록 하는 '키 설계'기법을 사용하기도 함

#### 데이터 변환

> 레디스와 리악과 같은 예외적은 NoSQL은 제외

- 관계형 데이터베이스의 데이터를 NoSQL로 전환하려면 관계형 데이터베이스에 저장된 관계 정보를 키의 이름으로 표현
  - table:id:field
- 문자열로 데이터 저장

#### 적절한 사용처

> 사용자의 프로필 정보, 웹 서버의 클러스터를 위한 세션 정보, 장바구니 정보, URL 단축 정보 저장

- 단일 연산에 의하여 처리를 완료하거나 취소할 수 있는 곳
- 대부분 키-값 모델 NoSQL은 데이터 자체의 값을 기준으로 검색하는 기능 지원하지 않기 때문에 해당 기능이 사용되지 않는 곳
- 복잡한 다중연산이 필요하지 않은 곳
  - 단일키 처리만을 지원하므로
- 다수의 데이터 조회 및 수정연산이 발생하면 트랜잭션 처리가 불가능하여 데이터의 정합성을 보장할 수 없음
- 복잡한 연산 역시 다수의 데이터 조회와 저장을 수반하므로 성능에 악영향

### 3.4.2 문서 모델 NoSQL

- 키-값 모델을 개념적으로 확장한 구조
- 하나의 키에 구조화된 문서를 저장하고 조회
- 논리적인 데이터의 저장과 조회 방법이 관계형 데이터베이스와 유사하기 때문에 NoSQL을 처음 도입하는 프로젝트에서 많이 선택

#### 공통 특징

- URL을 이용하여 웹 서버에 저장된 HTML 문서를 조회하는 것과 유사한데, URL이 키에 해당하고 HTML 문서가 저장된 데이터에 해당
- 구조화된 문서란 JSON, BSON, XML과 같이 문서가 이미 구조를 알고있는 것
- 키는 문서에 대한 ID
- 저장된 문서를 컬렉션으로 관리
- 문서 저장과 동시에 문서 ID에 대한 인덱스 생성
  - O(1) 시간에 문서 조회
- 저장된 문서의 형태에 따라 키 이외의 2차 인덱스 지원
  - 값을 비교한 조회 가능
  - B트리 인덱스를 이용하므로 크기가 커지면 커질수록 새로운 데이터를 입력하거나 삭제할 때 성능이 떨어짐
- MongoDB, 카우치베이스, 테라스토어, 레이븐DB, ...

#### 데이터 저장 방법

- 구조화된 문서 데이터 저장
- 문서 안에 문서를 포함하는 내포 관계를 정의하거나 문서의 참조 지정 가능
- 항상 고정된 필드를 가진 구조의 문서를 저장팔 필요 없음
- 데이터에 대한 검색을 시도할 때, 조회 조건에 지정된 필드가 존재하지 않는 문서는 조회 대상에 포함되지 않음

#### 데이터 변환

- table:id:field
- 키 하나에 여러 정보를 포함하는 문서 구조를 저장

#### 적절한 사용처

- B트리의 특성으로 인하여 한 번 작성되면 자주 변하지 않는 정보를 저장하고 조회하는 데 적합
  - 중앙 집중식 로그 저장, 타임라인 저장, 통계 정보 저장
  - 조회 시 특정 수량을 기준으로 잘라서 조회하는 기능 등에는 알맞지 않음
- 2차 인덱스와 검색 조건을 사용한 쿼리를 너무 신뢰하여 관계형 데이터베이스의 스키마를 그대로 문서 모델 NoSQL로 옮기면 실패할 수 있음
  - 관계형 데이터베이스의 기능에는 아직 못 미침
- 2차 인덱스는 조회 기능의 편의성을 제공하기도 하지만, 쓰기 성능을 저하시킴

### 3.4.3 컬럼 모델 NoSQL

- 하나의 키에 여러 개의 칼럼 이름과 칼럼 값의 쌍으로 이루어진 데이터를 저장하고 조회
- 단일 키에 의한 단일 칼럼 및 범위 조회 가능
- 모든 칼럼은 항상 타임스탬프값과 함께 저장
- 키는 로우키로 불림
- 가장 복잡한 저장구조를 가지는 NoSQL

#### 공통 특징

- 대부분의 컬럼 모델 NoSQL은 구글 빅테이블의 영향을 받아 개발
  - 로우키, 컬럼키, 컬럼 패밀리 같은 빅테이블 개념이 공통적으로 사용
- 저장과 조회의 기본 단위는 컬럼
- 컬럼은 컬럼 이름과 컬럼 값, 타임스탬프로 구성
- 컬럼의 집합은 로우, 로우키는 각 로우를 유일하게 식별하는 값
- 로우의 집합은 테이블 또는 키 스페이스
- 컬럼 하나를 조회할 때는 행을 구분하는 로우키와 열을 구분하는 컬럼키를 사용
  - 스프레드시트에서 X축, Y축에 따라 셀을 조회하는 방법과 동일
- HBase, 카산드라, 하이퍼 테이블

##### 관계형 데이터베이스와 차이 - 데이터 파일의 저장 방법

- 관계형 데이터베이스는 물리적으로 데이터를 저장할 때, 컬럼의 집합인 레코드를 기준으로 데이터 파일을 생성하지만, 컬럼 모델 NoSQL은 컬럼 패밀리를 기준으로 데이터 파일을 생성
- 이와 같은 이유로 하나의 로우에 저장된 모든 컬럼을 조회하는 것보다 로우키에 해당하는 컬럼패밀리를 조회하는 것이 더 빠름 
- 또한 하나의 로우에 많은 컬럼 패밀리를 지정하면 하나의 로우를 조회하기 위해서 더 많은 물리적 파일에 접근하게 되어 응답시간이 늘어남

##### 관계형 데이터베이스와 차이 - 타임스탬프

- 저장된 컬럼에 대한 타임스탬프 유지
- 관계형 데이터베이스가 로우 하나를 저장할 때는 스키마 레벨에서 저장 가능한 필드 개수가 고정되는 반면, 컬럼 모델 NoSQL의 스키마는 컬럼 패밀리만을 지정하고 컬럼의 개수나 이름을 지정하지 않음

#### 적절한 사용처

- 대부분의 컬럼 모델 NoSQL은 쓰기와 읽기 중 쓰기에 더 특화
- 이와 같은 이유로 읽기 연산 대비 쓰기 연산이 많은 서비스나 빠른 시간 안에 대량의 데이터를 입력하고 조회하는 서비스를 구현할 때 가장 좋은 성능을 나타냄
- 채팅 내용 저장, 메일 저장소, 알림 내용 저장, 실시간 분석을 위한 데이터 저장소, ...

### 3.4.4 그래프 모델 NoSQL

- 노드와 관계(또는 버텍스와 엣지라고 함)를 사용하여 데이터를 저장하고 조회
  - 관계는 속성이라는 부가정보를 가진다.
- 관계형 데이터베이스와 가장 유사

#### 공통 특징

- 노드와 노드 간의 관계를 저장하며 노드가 하나일 때는 관계를 지정할 수 없음
- 노드의 조회를 위해서 관계를 조회 조건으로 사용
- 관계는 방향성을 가지기도 하는데, 이 방향성에 의하여 여러 단계의 조회 가능 - 순회
- 많이 알려지지 않아 서비스 도입 사례가 적으며, 그래프 자체의 복잡성으로 인하여 도입을 위한 기술적 장벽 존재

#### 적절한 사용처

- 친구 추천과 같은 연관검색을 위한 정보를 저장하고 조회하는데 적합
- 추천 시스템, 다중 관계를 가진 엔티티를 저장하고 조회하는 데 알맞음

## 3.5 언제 NoSQL을 사용해야 하는가

- 대량의 단순 정보를 빠르게 저장하고 조회할 때
- 관계형 데이터베이스가 처리하지 못하는 대량의 데이터를 입력할 때 (보통 수십 기가바이트의 데이터)
- 스키마가 고정되지 않은 데이터를 저장하고 조회할 때
- 관계형 데이터베이스의 특성상 제공 가능한 성능에 한계가 있는데 그 한계를 넘어선 성능이 필요할 때
